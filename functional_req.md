# Функциональные требования к системе мониторинга Kafka

## Описание системы

Информационная система для мониторинга Apache Kafka в облачной платформе SberCloud предназначена для обеспечения стабильного и непрерывного сбора метрик Kafka-кластера и других облачных сервисов (Redis, MongoDB, PostgreSQL), их передачи в Prometheus и хранения в Mimir с последующей визуализацией в Grafana. Система решает проблему таймаутов и прерывистой доставки метрик, вызванных ограничениями облачного экспортера SberCloud, без необходимости изменения архитектуры или настроек безопасности.

Система автоматизирует следующие процессы:
- **Получение параметров Kafka**: Автоматическое извлечение адреса брокеров и учетных данных Kafka-инстанса через SberCloud API.
- **Сбор метрик**: Сбор метрик Kafka и облачных сервисов (CPU, RAM, операции чтения/записи) из Kafka-топиков, созданных Cloud Eye.
- **Интеграция с Prometheus и Mimir**: Передача метрик в Prometheus для обработки и в Mimir для долгосрочного хранения в S3.
- **Визуализация данных**: Отображение метрик в Grafana для анализа состояния кластера и облачных сервисов.
- **Развертывание в Kubernetes**: Упрощённое развертывание с использованием Helm chart.

Система реализована на базе микросервисной архитектуры, что обеспечивает гибкость, масштабируемость и устойчивость к сбоям. Это позволяет DevOps-команде оперативно реагировать на проблемы в Kafka-кластере и других облачных сервисах.

## Бизнес-цели

- Устранить таймауты и прерывания в доставке метрик, вызванные облачным экспортером SberCloud, обеспечив 100% стабильность сбора метрик.
- Сократить время обнаружения и устранения проблем в Kafka-кластере и облачных сервисах (Redis, MongoDB, PostgreSQL) до 10 минут.
- Автоматизировать настройку мониторинга Kafka через SberCloud API, сократив время конфигурации на 70%.
- Обеспечить долгосрочное хранение метрик в S3 с использованием Mimir для анализа исторических данных.
- Повысить доступность метрик (CPU, RAM, чтение/запись) для DevOps-команды на 100% через Prometheus и Grafana.

## Основные преимущества системы

- Устранение таймаутов и обеспечение непрерывного сбора метрик без изменения архитектуры или безопасности SberCloud.
- Автоматизация настройки мониторинга, исключающая ручное конфигурирование параметров Kafka.
- Долгосрочное хранение метрик в S3 с использованием Mimir, в отличие от ограниченного хранения в Prometheus.
- Удобная визуализация метрик Kafka и облачных сервисов в Grafana, упрощающая анализ состояния инфраструктуры.
- Гибкость и масштабируемость за счёт микросервисной архитектуры, Helm и Kubernetes.

## Функции системы

1. **Получение параметров Kafka-инстанса**:
   - Извлечение адреса Kafka-брокеров, имени пользователя и других параметров через SberCloud API.
   - Проверка доступности Kafka-инстанса по заданному имени.
   - Сохранение параметров в переменные окружения и файл конфигурации (`kafka_env.sh`).

2. **Сбор метрик Kafka и облачных сервисов**:
   - Сбор метрик Kafka (брокеры, топики, партиции, консьюмер-группы) из Kafka-топиков, созданных Cloud Eye.
   - Сбор метрик облачных сервисов (Redis, MongoDB, PostgreSQL), включая CPU, RAM, операции чтения/записи.
   - Предоставление метрик через HTTP-эндпоинт `/metrics` в формате, совместимом с Prometheus.

3. **Интеграция с Prometheus и Mimir**:
   - Передача метрик в Prometheus для обработки в реальном времени.
   - Передача метрик в Mimir для долгосрочного хранения в S3.
   - Автоматическая регистрация Kafka Exporter как источника метрик в Prometheus через ServiceMonitor.

4. **Визуализация метрик**:
   - Поддержка импорта дашбордов Grafana (например, ID 7589) для отображения метрик Kafka.
   - Формирование графиков и таблиц для метрик облачных сервисов (CPU, RAM, чтение/запись).
   - Отображение метрик, таких как `kafka_brokers`, `kafka_consumergroup_lag`, а также использования ресурсов Redis, MongoDB, PostgreSQL.

5. **Развертывание и управление**:
   - Упаковка и установка Helm chart для развертывания Kafka Exporter в Kubernetes.
   - Настройка параметров мониторинга через `values.yaml` (например, адрес Kafka, количество реплик).
   - Поддержка обновления и масштабирования сервиса через Helm.

6. **Уведомления и логирование**:
   - Логирование процесса получения параметров Kafka, сбора метрик и взаимодействия с Cloud Eye.
   - Настройка уровней логирования Kafka Exporter (`debug`, `info`, `warn`, `error`, `fatal`) через аргументы.

## Функциональные требования к отдельным сервисам

### Микросервис MS-Kafka-Config
- **Получение параметров Kafka**:
  - Аутентификация в SberCloud IAM API с использованием имени пользователя, пароля и домена.
  - Запрос списка проектов и получение ID проекта по имени.
  - Запрос списка Kafka-инстансов через SberCloud DMS API.
  - Извлечение параметров Kafka-инстанса (адрес брокеров, имя пользователя) по заданному имени инстанса.
- **Сохранение параметров**:
  - Запись параметров Kafka (брокеры, имя пользователя) в переменные окружения (`AMAZME_KAFKA_URL`, `AMAZME_KAFKA_USER`).
  - Создание файла `kafka_env.sh` с экспортируемыми переменными для использования Kafka Exporter.
- **Обработка ошибок**:
  - Проверка наличия обязательных переменных окружения (`PROJECT_NAME`, `AMAZME_KAFKA_PASSWORD`, `AMAZME_KAFKA_INSTANCE_NAME`).
  - Выдача понятных сообщений об ошибках при отсутствии инстанса или некорректных данных.

### Микросервис MS-Kafka-Exporter
- **Сбор метрик Kafka и облачных сервисов**:
  - Подключение к Kafka-кластеру с использованием параметров, предоставленных MS-Kafka-Config.
  - Чтение метрик Kafka (брокеры, топики, партиции, консьюмер-группы) из топиков, созданных Cloud Eye.
  - Чтение метрик облачных сервисов (Redis, MongoDB, PostgreSQL), включая CPU, RAM, операции чтения/записи.
  - Формирование метрик в формате Prometheus (например, `kafka_brokers`, `kafka_consumergroup_lag`, `redis_cpu_usage`).
- **Предоставление метрик**:
  - Запуск HTTP-сервера на порту 9308 с эндпоинтом `/metrics`.
  - Обеспечение стабильной доставки метрик в Prometheus, устраняя таймауты облачного экспортера.
- **Конфигурация**:
  - Поддержка настройки через аргументы командной строки (например, уровень логирования, параметры подключения).
  - Использование переменных окружения для динамической конфигурации.

### Микросервис MS-Monitoring
- **Интеграция с Prometheus и Mimir**:
  - Регистрация Kafka Exporter как источника метрик в Prometheus через Kubernetes ServiceMonitor.
  - Передача метрик в Prometheus для обработки в реальном времени.
  - Настройка Mimir для долгосрочного хранения метрик в S3.
- **Визуализация в Grafana**:
  - Поддержка импорта дашбордов Grafana (например, Kafka Exporter Overview, ID 7589).
  - Формирование пользовательских дашбордов для метрик Kafka и облачных сервисов (CPU, RAM, чтение/запись).
- **Хранение данных**:
  - Хранение метрик в Prometheus для краткосрочного анализа.
  - Хранение метрик в Mimir (S3) для долгосрочного анализа и исторических данных.